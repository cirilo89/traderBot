{% extends "base.html" %}
{% block body %}
<div class="container py-4">
  <h3>Estado de la cartera</h3>
  <div id="balanceInfo" class="mb-2">
  <!-- aquí insertaremos saldo vía JS -->
</div>
<div class="responsive-table">
    <table id="tblState" class="table table-sm table-striped w-100">
      <thead><tr>
        <th>Par</th>
        <th>Estado</th>
        <th>Cantidad</th>
        <th>Entrada</th>
        <th>Unrealizado</th>
      </tr></thead>
    </table>
</div>

  <h3 class="mt-4">Historial de operaciones</h3>
  <div class="responsive-table">
    <table id="tblHist" class="table table-sm table-bordered w-100">
      <thead><tr>
        <th>Fecha</th><th>Par</th><th>Tipo</th><th>Precio</th>
      </tr></thead>
    </table>
  </div>

  <h3 class="mt-4">Logs de evaluaciones</h3>
  <div class="responsive-table">
    <table id="tblLogs" class="table table-sm table-bordered w-100">
      <thead><tr>
        <th>Fecha</th><th>Par</th><th>Close</th><th>RSI</th><th>SMA</th><th>Decisión</th><th>Motivo</th>
      </tr></thead>
    </table>
  </div>
</div>

<script>
function loadTables(){

      // ---- Balance EUR + beneficio ----
  fetch('/api/balance')
    .then(r => r.json())
    .then(bal => {
      const eur = bal.free.toFixed(2);
      const ben = bal.benefit.toFixed(2);
      document.getElementById('balanceInfo').innerHTML =
        `<strong>Saldo libre:</strong> € ${eur} &nbsp; | &nbsp; ` +
        `<strong>Beneficio total:</strong> € ${ben}`;
    });

  // ---- Estado por par ----
  fetch('/api/state').then(r=>r.json()).then(data=>{
    const rows = Object.entries(data).map(([p,s])=>[
      p, s.position ? 'Abierta' : '—',
      s.amount.toFixed(6),
      s.entry.toFixed(2),
      s.unreal.toFixed(2)
    ]);
    $('#tblState').DataTable({data:rows, destroy:true,
                              searching:false, paging:false});
  });


// Historial
fetch('/api/history').then(r=>r.json()).then(data=>{
  const rows = data.map(x=>[
    x.datetime,
    x.pair,
    x.side,                   // ahora usamos la propiedad 'side' (buy/sell)
    (+x.price).toFixed(2)     // y 'price' en lugar de 'Close'
  ]);

  $('#tblHist').DataTable({data:rows, destroy:true, pageLength:10});
});


  // Logs
  fetch('/api/logs').then(r=>r.json()).then(data=>{
    const rows = data.map(x=>[
      x.datetime, x.pair,
      (+x.Close).toFixed(2), x.RSI, x.SMA, x.decision, x.motivo
    ]);
    $('#tblLogs').DataTable({data:rows, destroy:true, pageLength:25});
  });
}

loadTables();


setInterval(loadTables, 60000); // refresca cada minuto
</script>
{% endblock %}
